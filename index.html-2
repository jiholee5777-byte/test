<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<title>Season Tetris</title>
<style>
  body {
    margin: 0;
    background: #111;
    display: flex;
    justify-content: center;
    align-items: center;
    height: 100vh;
    overflow: hidden;
  }
  #container {
    position: relative;
  }
  canvas {
    border: 3px solid #555;
  }
  #score {
    position: absolute;
    top: -40px;
    left: 0;
    color: white;
    font-size: 20px;
  }
</style>
</head>
<body>

<div id="container">
  <div id="score">점수: 0</div>
  <canvas id="tetris" width="240" height="400"></canvas>
</div>

<script>
const canvas = document.getElementById('tetris');
const ctx = canvas.getContext('2d');
ctx.scale(20, 20);

const scoreEl = document.getElementById('score');
const arena = createMatrix(12, 20);

const seasons = {
  spring: {
    bg: '#F0FFF0',
    colors: [null,'#FFB6C1','#98FB98','#FF69B4','#7FFFD4','#ADFF2F','#FFA07A','#87CEFA']
  },
  summer: {
    bg: '#E0FFFF',
    colors: [null,'#00CED1','#FFD700','#32CD32','#FF8C00','#1E90FF','#FF4500','#00FA9A']
  },
  autumn: {
    bg: '#FFF5EE',
    colors: [null,'#CD853F','#FF8C00','#A0522D','#B22222','#DAA520','#D2691E','#8B4513']
  },
  winter: {
    bg: '#F8F8FF',
    colors: [null,'#ADD8E6','#E6E6FA','#AFEEEE','#B0E0E6','#F0FFFF','#DCDCDC','#FFFFFF']
  }
};

let currentSeason = 'spring';
let colors = seasons.spring.colors;

const player = {
  pos: {x: 0, y: 0},
  matrix: null,
};

let score = 0;
let shakeTime = 0;

function createMatrix(w, h) {
  return Array.from({length: h}, () => new Array(w).fill(0));
}

function createPiece(type) {
  if (type === 'T') return [[0,1,0],[1,1,1],[0,0,0]];
  if (type === 'O') return [[2,2],[2,2]];
  if (type === 'L') return [[0,0,3],[3,3,3],[0,0,0]];
  if (type === 'J') return [[4,0,0],[4,4,4],[0,0,0]];
  if (type === 'I') return [[0,5,0,0],[0,5,0,0],[0,5,0,0],[0,5,0,0]];
  if (type === 'S') return [[0,6,6],[6,6,0],[0,0,0]];
  if (type === 'Z') return [[7,7,0],[0,7,7],[0,0,0]];
}

function collide(arena, player) {
  return player.matrix.some((row,y)=>
    row.some((v,x)=> v!==0 &&
      (arena[y+player.pos.y]?.[x+player.pos.x])!==0)
  );
}

function merge(arena, player) {
  player.matrix.forEach((row,y)=>{
    row.forEach((v,x)=>{
      if(v!==0) arena[y+player.pos.y][x+player.pos.x]=v;
    });
  });
}

function rotate(m) {
  m.forEach((row,y)=>{
    row.forEach((_,x)=>{
      if(x<y)[m[x][y],m[y][x]]=[m[y][x],m[x][y]];
    });
  });
  m.forEach(row=>row.reverse());
}

function arenaSweep() {
  let lines = 0;
  outer: for(let y=arena.length-1;y>=0;y--){
    for(let x=0;x<arena[y].length;x++){
      if(arena[y][x]===0) continue outer;
    }
    arena.splice(y,1);
    arena.unshift(new Array(arena[0].length).fill(0));
    lines++;
    y++;
  }

  if(lines>0){
    score += lines * 10; // 줄당 10점
    scoreEl.textContent = `점수: ${score}`;
    shakeTime = 15;
    updateSeason();
  }
}

function updateSeason() {
  const seasonOrder = ['spring','summer','autumn','winter'];
  const index = Math.floor(score / 20) % seasonOrder.length; // 20점 단위
  currentSeason = seasonOrder[index];
  colors = seasons[currentSeason].colors;
}

function playerReset() {
  const pieces = 'ILJOTSZ';
  player.matrix = createPiece(pieces[Math.random()*pieces.length|0]);
  player.pos.y = 0;
  player.pos.x = (arena[0].length/2|0)-(player.matrix[0].length/2|0);
  if(collide(arena,player)) arena.forEach(r=>r.fill(0));
}

function playerDrop() {
  player.pos.y++;
  if(collide(arena,player)){
    player.pos.y--;
    merge(arena,player);
    playerReset();
    arenaSweep();
  }
}

function playerMove(d){
  player.pos.x+=d;
  if(collide(arena,player)) player.pos.x-=d;
}

function drawMatrix(m,o){
  m.forEach((row,y)=>{
    row.forEach((v,x)=>{
      if(v!==0){
        ctx.fillStyle = colors[v];
        ctx.fillRect(x+o.x,y+o.y,1,1);
      }
    });
  });
}

function draw(){
  canvas.style.background = seasons[currentSeason].bg;

  let shakeX=0, shakeY=0;
  if(shakeTime>0){
    shakeX = ((Math.random()-0.5)*0.5)/20;
    shakeY = ((Math.random()-0.5)*0.5)/20;
    shakeTime--;
  }

  ctx.save();
  ctx.translate(shakeX, shakeY);
  ctx.clearRect(0,0,canvas.width,canvas.height);
  drawMatrix(arena,{x:0,y:0});
  drawMatrix(player.matrix,player.pos);
  ctx.restore();
}

let dropCounter=0, dropInterval=500, lastTime=0;

function update(time=0){
  const deltaTime = time - lastTime;
  lastTime = time;
  dropCounter += deltaTime;
  if(dropCounter > dropInterval){
    playerDrop();
    dropCounter = 0;
  }
  draw();
  requestAnimationFrame(update);
}

document.addEventListener('keydown',e=>{
  if(e.key==='ArrowLeft') playerMove(-1);
  if(e.key==='ArrowRight') playerMove(1);
  if(e.key==='ArrowDown') playerDrop();
  if(e.key==='ArrowUp') rotate(player.matrix);
  if(e.key===' ') while(!collide(arena,player)) player.pos.y++;
});

playerReset();
update();
</script>
</body>
</html>
